<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Chat App (Secure)</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    
    <style>
        /* ... стили ... */
    <title>Chat App (Secure)</title>
    <style>
        body { margin: 0; padding-bottom: 3rem; font-family: sans-serif; }
        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages li { padding: 0.5rem 1rem; }
        #messages li:nth-child(odd) { background: #efefef; }
        #chat { background: #333; padding: 0.25rem; display: flex; box-sizing: border-box; }
        #chat > input, #chat > button { border: none; padding: 0.5rem; margin: 0.25rem; }
        #chat > input:focus { outline: none; }
        #chat > button { background: #1a73e8; color: white; }
        .hidden { display: none; }
        #auth-form { padding: 20px; border: 1px solid #ccc; max-width: 400px; margin: 50px auto; text-align: center; }
        #auth-form input { margin: 10px 0; padding: 10px; width: 80%; display: block; margin-left: auto; margin-right: auto; }
        #auth-form button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <ul id="messages"></ul>

    <form id="auth-form" action="">
        <h2>Вход / Регистрация</h2>
        <input id="auth-username" autocomplete="off" placeholder="Имя пользователя" required />
        <input id="auth-password" type="password" autocomplete="off" placeholder="Пароль" required />
        <button id="register-btn" type="button">Регистрация</button>
        <button id="login-btn">Войти</button>
        <p id="auth-message" style="color: red;"></p>
    </form>

    <form id="chat" action="" class="hidden">
        <input id="username" autocomplete="off" placeholder="Ваше Имя" style="width: 100px;" readonly />
        <input id="receiver" autocomplete="off" placeholder="Получатель (для ЛС)" style="width: 150px;" />
        <input id="m" autocomplete="off" placeholder="Сообщение..." style="flex-grow: 1;" />
        <button>Отправить</button>
    </form>
    
    <script src="/socket.io/socket.io.js"></script> 
    
    <script>
        const socket = io(); 

        // Элементы аутентификации
        const authForm = document.getElementById('auth-form');
        const authUsernameInput = document.getElementById('auth-username');
        const authPasswordInput = document.getElementById('auth-password');
        const registerBtn = document.getElementById('register-btn');
        const authMessage = document.getElementById('auth-message');

        // Элементы чата
        const chatForm = document.getElementById('chat');
        const inputMessage = document.getElementById('m');
        const inputReceiver = document.getElementById('receiver'); 
        const inputChatUsername = document.getElementById('username'); 
        const messages = document.getElementById('messages');

        let currentUsername = null; 
        
        // --- Логика Аутентификации ---
        
        registerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const username = authUsernameInput.value.trim();
            const password = authPasswordInput.value;
            if (username && password) {
                socket.emit('register', { username, password });
            }
        });

        authForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = authUsernameInput.value.trim();
            const password = authPasswordInput.value;
            // Проверяем, что нажата именно кнопка "Войти"
            if (e.submitter && e.submitter.id === 'register-btn') return;
            
            if (username && password) {
                socket.emit('login', { username, password });
            }
        });

        socket.on('auth error', function(msg) {
            authMessage.textContent = msg;
            authMessage.style.color = 'red';
        });

        socket.on('auth message', function(msg) {
            authMessage.textContent = msg;
            authMessage.style.color = 'green';
        });

        socket.on('auth success', function(data) {
            // Успешный вход
            currentUsername = data.username;
            
            // Скрываем форму входа и показываем чат
            authForm.classList.add('hidden');
            chatForm.classList.remove('hidden');
            inputChatUsername.value = currentUsername;
            
            authMessage.textContent = `Добро пожаловать, ${currentUsername}!`;
            authMessage.style.color = 'blue';

            // Отправляем серверу, что мы вошли
            socket.emit('authenticate', currentUsername);
        });
        
        // --- Логика Чата ---
        
        function displayMessage(data) {
            const item = document.createElement('li');
            const sender = data.sender;
            const msg = data.msg;

            item.innerHTML = `<strong>${sender}:</strong> ${msg}`;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        }

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const message = inputMessage.value.trim();
            const receiver = inputReceiver.value.trim(); 
            
            if (message && currentUsername) {
                const data = {
                    sender: currentUsername,
                    receiver: receiver || null, 
                    msg: message
                };
                
                socket.emit('chat message', data); 
                inputMessage.value = ''; 
                inputReceiver.value = ''; 
            }
        });
        
        socket.on('chat message', function(data) {
            displayMessage(data);
        });

        socket.on('history', function(history) {
            messages.innerHTML = ''; 
            history.forEach(item => {
                // В коде index.js мы сохраняли и sender, и msg
                displayMessage({ sender: item.sender, msg: item.msg });
            });
            displayMessage({ sender: '[СИСТЕМА]', msg: '--- История загружена ---' });
        });
    </script>
</body>
</html>